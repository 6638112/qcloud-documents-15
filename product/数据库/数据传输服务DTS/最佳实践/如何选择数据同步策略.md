## 操作场景

DTS 支持多对一、一对多、联级单向、双向同步、联级双向同步等复杂拓扑结构，在复杂拓扑结构中，多个节点同时进行数据写入，可能会发生主键冲突问题，DTS 支持对主键冲突进行检测，并提供如下主键冲突的处理机制。

| **主键冲突策略** | **说明**                                                     | **冲突处理时 SQL 语句改写**                                    |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 冲突报错         | 同步任务中，源库插入（INSERT）主键数据与目标库存在冲突时，任务报错并暂停，需要用户手动处理后才能继续。 | <li>INSERT 不改写<li>UPDATE 不改写<li>DELETE 不改写           |
| 冲突忽略         | 同步任务中检测到源库的主键插入（INSERT）数据与目标库发生冲突时，忽略源库的主键插入数据，以目标库的内容为准。 | <li>INSERT > INSERT IGNORE  <li>UPDATE 不改写<li>DELETE 不改写 |
| 冲突覆盖         | 同步任务中检测到源库的主键更新（INSERT和UPDATE）数据与目标库发生冲突时，用源库的主键数据覆盖目标的主键数据。 | <li>INSERT > REPLACE INTO<li> UPDATE > DELETE + REPLACE INTO<li>DELETE 不改写</li> |

## 冲突策略应用示例

DTS 冲突策略的应用，仅针对发生主键冲突时的数据，应用后可以按用户设置的策略进行处理，使任务报错提醒给用户或者继续运行。不产生冲突的场景，源端的操作都会正常同步到目标端，DTS 不会干预。

DTS 干预冲突的场景有如下两种，场景一（INSERT 主键引起冲突）和场景二（UPDATE 主键引起冲突，并且仅在设置冲突覆盖时进行 SQL 改写）。各场景示例中，均构建 A >B 的单向同步，ID 为主键数据。

#### 场景一：INSERT 后引起冲突

INSERT 主键后，数据同步到 B 上引起冲突，DTS 按照设置的冲突策略进行干预处理。

![](https://qcloudimg.tencent-cloud.cn/raw/570b2e05d6234a13062293e3d11504d7.png)

1. 初始状态，A只有库表结构，无数据，B为空。
2. 构建单向同步任务 A > B。
3. 在 B 中 INSERT 数据（ID=1, Price=10）
4. 在 A 中 INSERT 同样的主键数据（ID=1, Price=20）。

最终同步后 B 上的结果，DTS 会根据设置的冲突策略进行干预。

#### 场景二：UPDATE 后引起冲突

UPDATE 主键后，数据同步到 B 上与 B 本身已存在的主键数据发生冲突，仅设置冲突覆盖策略时，DTS 会进行 SQL 改写的干预处理。

![](https://qcloudimg.tencent-cloud.cn/raw/c7b44716b540346f1fe1754136697687.png)

1. 初始状态，A 有数据 （ID=1, Price=10），B 为空。
2. 构建单向同步任务 A > B，同步后 A、B 数据都为（ID=1, Price=10）。
3. 在 B 中 INSERT 数据（ID=2, Price=20）。
4. 在 A 中 UPDATE 数据，将 ID 为1的主键修改为 ID=2（ID=1> ID=2），同步到 B 上的时候，与 B 中 ID 为2的数据发生冲突。

最终同步后，仅设置冲突覆盖，DTS 才会进行 SQL 改写的干预，冲突忽略和冲突报错会报错。

#### 场景三：UPDATE 后无冲突

UPDATE 主键后，数据同步到 B 上无冲突，按照正常的 UPDATE 操作进行，DTS 不干预。

![](https://qcloudimg.tencent-cloud.cn/raw/d30fb1f6f19068f91019223d7db8fd72.png)

1. 初始状态，A 有数据（ID=1, Price=10），B 为空。
2. 构建单向同步任务 A > B，同步后 A、B 数据都为（ID=1, Price=10）。
3. 在 A 中 UPDATE 数据，将 ID 为1的主键修改为 ID=2（ID=1 > ID=2），同步到 B 后，B 中无 ID 为2的主键数据，无冲突。

最终同步后，无论设置什么冲突策略，DTS 都不会干预，因为没有冲突，B 上的结果以 A 的更新为准。

## 主键冲突策略与数据一致性

在两地三中心，异地多活等复杂数据架构中，会有三个或三个以上节点需要同时进行数据写入，保证多个节点的一致性至关重要。

许多用户误以为可以通过主键冲突策略来保证数据以某一个节点为准进行更新，通过上述的场景举例可以得出，DTS 仅会对主键冲突的场景进行干预，没有冲突的场景 DTS 是不会干预的，所以通过主键冲突策略来实现数据一致性是不合理的。

在实际业务中，要实现多节点数据一致性，合理规划主键分区是非常有效的方法，可以从源头上避免产生冲突。在这个基础上再设置主键冲突策略，万一发生了冲突，可以进行干预或者提醒用户。

