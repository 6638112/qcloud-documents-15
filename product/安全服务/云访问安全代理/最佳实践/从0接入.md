# 从0开始接入CASB

本文以业务应用使用云数据库MySQL场景为例，介绍从0开始接入云访问安全安全代理的基本流程。

本例中，接入前业务应用使用如下信息访问数据库，表中存在三个敏感字段`name`、`phone`和`address`，数据库中的敏感字段明文存储。
```
IP:       172.16.48.7
Port:     3306
User:     root
Password: db123456
Database: casbtestdb
Table:    casbtesttable
```
![](https://qcloudimg.tencent-cloud.cn/raw/296c458c24b326cad711d77d424c7b23.jpg)

## 接入准备

### 1. 服务及账号授权
- 开通密钥管理系统（KMS）服务并完成 KMS 对云访问安全代理服务的角色授权。详情请参考 [使用 KMS 加密并授权](https://cloud.tencent.com/document/product/1303/48491)。
- 账号授权及策略配置。详情请参考 [账号授权管理](https://cloud.tencent.com/document/product/1303/48429)。

### 2. 创建 CASB 实例
进入 [云访问安全代理（CASB）控制台](https://console.cloud.tencent.com/casb)实例列表页，点击新建，进入CASB实例购买页面，并根据业务需求购买相应的功能。

> [购买说明](https://cloud.tencent.com/document/product/1303/53298)

本例中，使用的CASB实例信息如下。

![](https://qcloudimg.tencent-cloud.cn/raw/b40465782bded594bb91473429ec74f8.png)

##  绑定代理和数据库

### 1. 新建元数据，将数据库添加到CASB的元数据中。

根据参考文档[添加云元数据](https://cloud.tencent.com/document/product/1303/55925)，添加数据库到CASB元数据。

![](https://qcloudimg.tencent-cloud.cn/raw/74006369b494c391aac468a5f4d6206c.png)

![](https://qcloudimg.tencent-cloud.cn/raw/327e47a263c2a4f1ed0f30567d5cd03f.png)

### 2. 采集元数据表结构。

根据参考文档[更新表结构](https://cloud.tencent.com/document/product/1303/55927)，将数据库的表结构信息更新到CASB元数据中。

![](https://qcloudimg.tencent-cloud.cn/raw/128907d27fd302d0c56d0e972218d6ec.png)

### 3. 绑定元数据到CASB代理。

根据参考文档[Proxy资源绑定](https://cloud.tencent.com/document/product/1303/64636)，将元数据绑定到CASB代理的某个端口。

![](https://qcloudimg.tencent-cloud.cn/raw/dc1fa932c05f24e408b484ffc476ff3a.jpg)

本例中，将创建的metadata_demo元数据库绑定到了代理的`10103`端口，代理的访问地址为`172.16.0.48:10103`。

### 4. 创建访问代理的账号密码。

根据参考文档[创建代理账号](https://cloud.tencent.com/document/product/1303/64635)，创建访问代理地址的账号和密码。

![](https://qcloudimg.tencent-cloud.cn/raw/5d9e30ea531d686de2c179eb290d48df.png)

本例中，对代理地址`172.16.0.48:10103`创建了`casbroot`账号，密码为`casb123456`。

### 5. 验证代理的绑定状态。

到此为止，CASB已将完成数据库和代理的绑定，应用此时可通过CASB代理访问数据库。

* 数据库的连接信息为: `mysql -h172.16.48.7 -P3306 -uroot -pdb123456 casbtestdb`。
* 代理的连接信息为: `mysql -h172.16.0.48 -P10103 -ucasbroot -pcasb123456 casbtestdb`。

![](https://qcloudimg.tencent-cloud.cn/raw/d6a28a7b8f2aeaa8321fb98721f97e55.png)

因尚未配置数据库的字段加解密策略, 此时CASB代理相当于是透明代理。


## 配置加密策略

### 1. 确认字段长度是否满足密文存储需求。

根据参考文档[密文长度计算](https://cloud.tencent.com/document/product/1303/77864), 计算各字段中明文加密后的最大密文长度，若最大密文长度大于当前的字段长度定义，需调整字段长度大小。

本例中各字段长度定义已足够存储密文，不对字段长度定义进行修改。

### 2. 配置字段加密策略。

根据参考文档[创建策略](https://cloud.tencent.com/document/product/1303/64619)，配置各字段的加密策略。

本例中，对`name`和`address` 字段使用`SM4`加密，`phone`字段使用`AES`加密，并分别用了`key1`,`key2`,`key3`三个不同的密钥。
![](https://qcloudimg.tencent-cloud.cn/raw/74b94fe08c4f885e69d5305b32a04555.png)

### 3. 验证字段加密效果。

* 通过代理，写入明文数据。
* 通过代理，读取到新写入的数据和历史的数据均为明文。
* 直连数据库，读取到新写入的数据为密文。
![](https://qcloudimg.tencent-cloud.cn/raw/9c3a6da0ee7f7d707ff19ff1fc79bda2.png)

### 4. 存量数据加密

根据参考文档[创建全量加密任务](https://cloud.tencent.com/document/product/1303/64622), 创建全量加密任务并启动后，CASB后台会自动对存量的明文数据进行加密。

![](https://qcloudimg.tencent-cloud.cn/raw/b175d727cfa06e28a49f2b3575519e49.png)

全量加密任务执行完成后，直连数据库查询，所有数据均为密文。通过代理查询，所有数据均为明文。

![](https://qcloudimg.tencent-cloud.cn/raw/42aae7b59503ae2a4117b7984d4351bc.png)


## 配置脱敏策略

### 1. 配置脱敏策略
根据参考文档[新建脱敏策略](https://cloud.tencent.com/document/product/1303/56900), 创建代理账号`casbroot`访问代理时的脱敏策略。

![](https://qcloudimg.tencent-cloud.cn/raw/056cc253d1eee852f1fcf1af003df0aa.png)

本例中,`name`字段使用了内置的`中文姓名`脱敏算法，`phone`字段使用了内置的`保留前三后三`脱敏算法，`address`字段使用了内置的`置空`脱敏算法。

### 2. 验证脱敏效果
配置脱敏策略后，再使用`casbroot`通过代理访问数据库时，`name`、`phone`、`address`三个字段返回的数据均已进行了相应的脱敏，业务无法获取原始明文信息。

![](https://qcloudimg.tencent-cloud.cn/raw/82765eedd4808573805d7ef09e06f3b2.png)

---

至此，业务应用已完成的加解密和脱敏功能的接入。安全组配置、访问控制、数据库操作审计、敏感数据识别等更多功能配置和使用，请参考CASB文档。
