## 功能简介
流量调度管理是腾讯云 EdgeOne 提供的多 CDN 智能解析调度工具，支持在源站、多个服务商之间自定义流量调度策略，实现流量平滑灰度迁移和灵活分配，保证服务高可用。

#### 应用场景

- 灰度迁移：引入新服务商时，为了保证服务可用性，需要进行灰度切换，实现业务平滑迁移。配置参考见下方灰度迁移场景配置参考。
<img src="https://qcloudimg.tencent-cloud.cn/raw/cd45261d354efcb668253415143c2ed5.png" width=600px>

- 多厂商调度：业务量级较大且敏感，为了分散风险，希望将流量灵活分配给多家服务商，实现业务容灾。配置参考见下方多厂商场景调度配置参考。
<img src="https://qcloudimg.tencent-cloud.cn/raw/04269aeaa74e2f972625e44ecd61ec44.png" width=600px>

#### 功能特点
- 管理简单：选择域名 > 添加服务商 > 添加调度策略，仅需三步加即可实现流量调度管理。
- 快速接入：用户只需在 DNS 解析商处添加 EdgeOne 分配的 CNAME 记录即可实现快速接入。
- 多种调度模式：支持按比例、按区域的调度模式，可组合使用满足多样化需求。
- 覆盖场景多样：支持源站和 CDN 厂商作为调度服务商，可以满足灰度切换和同时使用多家服务商的场景。

## 前提条件
您的站点需要成功 [购买](https://cloud.tencent.com/document/product/1552/70194) 边缘安全加速平台（EdgeOne）产品（企业版套餐），且使用 CNAME 模式完成 [站点接入](https://cloud.tencent.com/document/product/1552/70788)。

## 配置指南
### 添加流量调度策略
#### 步骤一：进入流量调度管理页面   
登录 [边缘安全加速平台控制台](https://console.cloud.tencent.com/edgeone)，在左侧导览中，选择站点后单击**域名服务**，选择**流量调度管理**页面。
<img width="1365" alt="image" src="https://user-images.githubusercontent.com/116173601/204139321-03e2c0fe-9a5f-4267-b7cb-4df3d0f267e9.png">

#### 步骤二：选择域名

在流量调度管理页面，单击**添加调度策略**，选择需要开启流量调度的域名，单击**创建**。
<img width="1359" alt="image" src="https://user-images.githubusercontent.com/116173601/204139597-654fa7d9-b784-4999-9bad-880f633a9c66.png">

#### 步骤三：添加服务商

单击**添加服务商**，按照业务需求配置服务商名称、CNAME等参数，单击**下一步**。
>?提供默认服务商 EdgeOne，不可修改和删除。支持新增源站域名和其他 CDN 服务商 CNAME 域名。

<img width="1536" alt="image" src="https://user-images.githubusercontent.com/116173601/204242087-7ba5f0ca-77b1-477d-90e7-be414d798bd0.png">


#### 步奏四：添加策略   

单击**添加策略**，选择线路/区域，配置多服务商的调度策略，服务商支持多选以及权重设置，完成后单击**提交配置**。
>?
>- 默认策略为全部流量走 EdgeOne，该策略作为兜底策略不可删除，可支持修改为其他服务商。
>- 线路/区域支持国家地区，中国大陆运营商、省份、省份运营商，美国各洲和印度各邦。
>- 细粒度区域/线路生效优先级更高，如配置北京调度源站、中国大陆调度服务商 A 、默认线路调度服务商 B，则北京地区走源站，中国大陆其他区域走服务商 A，境外区域走服务商 B。
>

<img width="1537" alt="image" src="https://user-images.githubusercontent.com/116173601/204243355-419674b3-7b95-4706-8962-4ea671217669.png">


#### 步奏五：开启流量调度     
添加策略完成后，EdgeOne会给域名分配一个流量调度CNAME，该CNAME与域名的默认CNAME一致，您还需要前往您的 DNS 解析服务商完成 CNAME 配置，方可触发流量调度策略生效，如果域名解析已切换至EdgeOne，则无需变更，策略立即生效现网。域名解析切换可参考[CNAME接入](https://cloud.tencent.com/document/product/1552/70824)第4部分。
<img width="1353" alt="image" src="https://user-images.githubusercontent.com/116173601/204139712-a3385933-30d6-4df7-8fe1-a1fb52d90208.png">

### 管理流量调度策略
在左侧导览中，选择站点后单击**域名服务**，选择 **流量调度管理**页面，可以编辑管理、停用、启用和删除策略。
#### 停用策略
停用策略会导致流量调度策略失效，所有流量将全部调度使用 EdgeOne 进行服务。
#### 启用策略
停用的策略可通过启用恢复使用流量调度管理，启用后流量会从全部调度使用 EdgeOne 变更为按配置的策略进行调度。
#### 删除策略
停用策略后，可删除策略，删除不影响服务，但策略不可恢复，请谨慎操作。 
#### 管理策略
单击**管理**可以进入**调度策略管理**页面，可以对服务商和调度策略进行增加、删除、修改以及停用。
>?
>- 变更已被策略引用的服务商，保存后会立即生效到策略。
>- 删除和修改策略、启用和停用策略均会立即生效。
>- 已被策略引用的服务商，无法删除。
>
![](https://qcloudimg.tencent-cloud.cn/raw/d45f86def9d128bf18add56bd7128fec.png)

## 灰度迁移场景配置参考
### 场景假设
假设域名www.site.com，没有开启加速，所有流量直接指向源站服务器，源站地址为origin.site.com。

为保障网站的安全和提升用户服务体验，您购买EdgeOne企业版套餐服务，考虑到用户服务稳定，需要将流量平滑灰度切换至EdgeOne。

制定分三阶段灰度切换至EdgeOne：首先灰度1%，其次30%，最后100%。

### 步骤一：添加站点和域名

登录 [边缘安全加速平台控制台](https://console.cloud.tencent.com/edgeone)

1.参照[站点接入](https://cloud.tencent.com/document/product/1552/70788)指引添加站点，购买企业版本套餐，以及通过CNAME接入站点site.com。

2.参照[CNAME接入](https://cloud.tencent.com/document/product/1552/70824)添加域名www.site.com，添加后先不进行CNAME解析切换。

### 步奏二：添加初始灰度策略

1.在左侧导览中，选择站点后单击**域名服务**，选择**流量调度管理**页面。

2.在流量调度管理页面，单击**添加调度策略**，选择www.site.com，单击**创建**。

3.添加服务商，本场景因为是从源站迁移，则输入源站域名origin.site.com，服务名称可自定义填写。

<img width="1153" alt="image" src="https://user-images.githubusercontent.com/116173601/204138663-dcd17898-5484-4f44-8db6-47e5f143f6f0.png">

4.添加初始灰度策略并提交配置，考虑先将1%流量从源站切换到EdgeOne，服务一段时间无问题之后再增加灰度比例，则默认策略添加服务商源站域名权重99，EdgeOne权重1。

<img width="1155" alt="image" src="https://user-images.githubusercontent.com/116173601/204138748-21565ddb-4c56-42d9-b4a9-850c8227edd7.png">

### 步骤三：切换解析开始灰度

添加策略完成后，EdgeOne会给域名分配一个流量调度CNAME，该CNAME与域名的默认CNAME一致，您还需要前往您的 DNS 解析服务商完成 CNAME 配置，方可触发流量调度策略生效。域名解析切换可参考[CNAME接入](https://cloud.tencent.com/document/product/1552/70824)第4部分。

<img width="1353" alt="image" src="https://user-images.githubusercontent.com/116173601/204139712-a3385933-30d6-4df7-8fe1-a1fb52d90208.png">

### 步骤四：变更灰度比例

1.变更灰度30%流量切换至EdgeOne：灰度服务一段时间，确认服务没有问题后，可以进入流量调度管理进行变更灰度比例。

进入流量调度管理页面，选择www.site.com，操作栏点击管理进入编辑页面，编辑默认策略，将EdgeOne权重变更为30，源站域名变更为70，保存则策略立即生效，现网等待dns缓存过期后生效。

<img width="1588" alt="image" src="https://user-images.githubusercontent.com/116173601/204226113-bba1fe95-d9ab-45dd-8005-8e07f23fb620.png">

2.变更灰度100%流量切换至EdgeOne：编辑默认策略，删除源站域名，只保留EdgeOne，保存立即生效，则是100%流量切换至EdgeOne。

<img width="1573" alt="image" src="https://user-images.githubusercontent.com/116173601/204227612-300f8a87-fc42-4c1a-934d-a2164fc0e58e.png">


### 步奏五：完成灰度流程

100%灰度服务一段时间，确认服务没问题后，可以选择停用和关闭流量调度策略，停用和关闭对您的服务没有影响，流量依然全部采用EdgeOne服务。

## 多厂商调度场景配置参考
### 场景假设

假设存在域名a.site.com,当前所有流量使用CDN厂商B，考虑引入其他厂商共同调度，同时某厂商出现问题时，可以进行流量调度切换。

整体调度策略：
- 将中国大陆切换使用EdgeOne服务。
- 新加坡采用EdgeOne和CDN厂商A共同服务，EdgeOne占比60，CDN厂商A占比40%。
- 其他地区不变，依然采用CDN厂商B服务。

### 步奏一：添加站点和域名

登录 [边缘安全加速平台控制台](https://console.cloud.tencent.com/edgeone)

1.参照[站点接入](https://cloud.tencent.com/document/product/1552/70788)指引添加站点，购买企业版本套餐，以及通过CNAME接入站点site.com。

2.参照[CNAME接入](https://cloud.tencent.com/document/product/1552/70824)添加域名a.site.com，添加后先不进行CNAME解析切换。

### 步骤二：设置多厂商调度策略

1.在左侧导览中，选择站点后单击**域名服务**，选择**流量调度管理**页面。

2.在流量调度管理页面，单击**添加调度策略**，选择a.site.com，单击**创建**。

3.添加服务商，本场景因为是多厂商共同服务，默认有EdgeOne的调度CNAME，可再分别添加CDN厂商A、CDN厂商B的CNAME域名。
<img width="1165" alt="image" src="https://user-images.githubusercontent.com/116173601/204138384-4ade4f8e-ccca-42c3-bd52-ab5d0b9b0a24.png">

4.添加策略，选择中国大陆区域使用EdgeOne服务，新加坡地区60%使用EdgeOne服务，40%使用CDN厂商B服务，默认策略采用CDN厂商A服务。
<img width="1105" alt="image" src="https://user-images.githubusercontent.com/116173601/204139095-d592404f-f0f5-4147-a358-42e74732c79d.png">

### 步骤三：切换解析开始服务

添加策略完成后，EdgeOne会给域名分配一个流量调度CNAME，该CNAME与域名的默认CNAME一致，您还需要前往您的 DNS 解析服务商完成 CNAME 配置，方可触发流量调度策略生效，如果域名解析已切换至EdgeOne，则无需变更，策略立即生效现网。

域名解析切换可参考[CNAME接入](https://cloud.tencent.com/document/product/1552/70824)第4部分。
<img width="1353" alt="image" src="https://user-images.githubusercontent.com/116173601/204139712-a3385933-30d6-4df7-8fe1-a1fb52d90208.png">

### 步奏四：管理变更策略

当部分区域出现故障，需要切换或者业务需求需要将部分流量切换服务厂商，进入流量调度管理页面，选择a.site.com，操作栏点击管理进入编辑页面。

- 如中国香港原来由CDN厂商A服务，出现故障，可以马上修改为EdgeOne服务，保存策略立即生效，现网等待dns缓存过期后生效。
- 新加坡地区因为EdgeOne服务质量更好，变更选择将80%流量调度到EdgeOne，CDN厂商B保留20%，保存策略立即生效，现网等待dns缓存过期后生效。

<img width="1526" alt="image" src="https://user-images.githubusercontent.com/116173601/204239774-89f3a02d-c4af-4f98-8efa-93a19db8a5e5.png">

