
## 操作场景
本文介绍如何在 Kong 云原生网关上通过 Kong 流量镜像插件实现下述常见镜像场景：
- 将生产流量的一定比例镜像到测试后端
- 将生产流量镜像到多个测试后端

## 前置条件
- 已购买 Kong 网关实例，详情请参见 [实例管理](https://cloud.tencent.com/document/product/1364/72495)。
- 配置了后端（Service）以及路由（Route）。

## 插件说明
- 插件名称；TSE TRAFFIC MIRROR
- 插件分类：Traffic Control
- 概述：实现对客户端的请求进行流量镜像，在线流量将被镜像到测试后端，镜像后端返回的响应数据会被自动丢弃，保证镜像后端的测试业务不会影响到线上业务，广泛用于在测试环境中模拟在线流量对新功能进行测试的场景。
- 具体能力：
 - 支持镜像到 Kong Upstream 或镜像服务地址。
 - 支持根据采样比例镜像：支持配置转发给镜像后端的流量比例。
 - 支持根据请求参数进行镜像：通过将插件配置在 Route 上，匹配到请求参数的请求会进行镜像。
 - 支持镜像到多后端。

## 插件配置


| 配置项 | 是否必填 | 配置说明 |
|---------|---------|---------|
| 镜像比例 | 是 | 转发到镜像服务的请求比例，支持1-100。 |
| 后端地址类型 | 是 | 镜像服务类型，支持填写 Host 或 Upstream。 |
| 后端地址-Host | 否 | 镜像服务地址，需包含 schema（http/https）和 Host 地址，例如 http://127.0.0.1。 |
| 后端地址-Port | 否 | 镜像服务端口，支持1-65535。 |
| 后端地址-Upstream | 否 | 镜像服务的 Kong Upstream，需包含 schema（http/https）和 Upstream 名称，例如 http://myupstream。 |
| 后端地址-Path | 否 | 镜像服务路径，不指定则默认使用当前请求路径。 |

## 操作步骤

### 场景一：根据采样比例镜像
1. 登录 Konga 管理控制台，进入需要配置流量镜像的 Service 详情页，单击 **Add Plugin** 添加插件，在 Traffic Control 分组下选择 TSE TRAFFIC MIRROR 插件。
2. 在本场景中，模拟将线上30%的流量镜像到 Host 类型的测试后端。
3. 在插件中填写以下配置，单击 **ADD PLUGIN**：
 - 镜像比例：30%
 - 后端地址类型：Host
 - 后端地址：
	 - Host：填写测试服务访问地址，例如 http://example-test-service
	 - Port：填写测试服务端口
	 - Path：选填，不填使用真实请求路径
![](https://qcloudimg.tencent-cloud.cn/raw/2ae298d79ca3e48658d52ceebcf03d10.png)
4. 发起 API 请求，查看镜像后端收到一定比例的镜像请求。

### 场景二：镜像到多个后端
1. 登录 Konga 管理控制台，进入需要配置镜像的 Service 详情页，单击 **Add Plugin** 添加插件，在 Traffic Control 分组下选择 TSE BREAKER 插件。
2. 本场景模拟将流量镜像到多个 Upstream。
在插件中填写以下配置：
 - 镜像比例：100%
 - 后端地址类型：Upstream
 - 添加多个后端地址，每个后端地址填写：
	 - Upstream：填写镜像服务所在的 Upstream
	 - Path：选填，填写镜像请求路径
![](https://qcloudimg.tencent-cloud.cn/raw/d6f9d6f9784d8f8e0a816c036d82e062.png)
4. 发起 API 请求，在两个 Upstream 查看发起的镜像请求。


## 插件说明
- 插件名称：TSE PROXY REWRITE
- 插件分类：Transformations
- 概述：实现对客户端的请求和响应进行改写，支持使用Nginx内置变量。
- 具体能力：
 - 支持在请求或响应阶段对 query/header 参数进行新增、编辑、删除。
 - 当 content-type 为 application/json, multipart/form-data, application/x-www-form-urlencoded 时，支持在请求或响应阶段对 body 字段进行新增、编辑、删除。
 - 支持使用nginx变量重写请求/响应。



## 插件配置


| 配置项 | 是否必填 | 配置说明 |
|---------|---------|---------|
| Header 参数 | 否 | 支持配置多条，每条配置项包括生效阶段、操作类型、键、值。<li>生效阶段：支持请求、响应。</li><li>操作类型：支持新增、删除、编辑。</li><li>键值：输入请求/响应的 Header 参数名和值。</li>支持以 $var 的格式包含 NGINX 变量，例如 $remote_addr $balancer_ip。 |
| Query 参数 | 否 |  支持配置多条，每条配置项包括生效阶段、操作类型、键、值。<li>生效阶段：支持请求。</li><li>操作类型：支持新增、删除、编辑。</li><li>键值：输入请求的 Query 参数名和值。</li>支持以 $var 的格式包含 NGINX 变量，例如 $remote_addr $balancer_ip。 |
| Body | 否 |  支持配置多条，每条配置项填写生效阶段、操作类型、键、值。<li>生效阶段：支持请求、响应。</li><li>操作类型：支持新增、删除、编辑。</li><li>键值：当 content-type 为 application/json, multipart/form-data, application/x-www-form-urlencoded 时，输入 body 字段的参数名和值。</li> |
>!当操作类型为编辑时，如果指定的参数不存在，则会按照新增操作新增键和值；如果指定的参数已存在，则会进行值替换。

## 操作步骤

### 场景一：实现响应阶段增加 Header 参数 

1. 登录 Konga 管理控制台，进入需要配置响应改写的 Service 详情页，单击 **Add Plugin** 添加插件，在 Transformations 分组下选择 TSE PROXY REWRITE 插件。
2. 在插件中填写以下配置，实现响应阶段新增一个 Header 参数。
![](https://qcloudimg.tencent-cloud.cn/raw/d2bab32bc82743f6d068168c3aef0267.png)
3. 发起 API 请求，查看后端服务的响应是否新增添加的 Header 参数。
<dx-codeblock>
:::  YAML
HTTP/1.1 200 OK
Addheader: test
Connection: keep-alive
Content-Length: 20
Content-Type: application/octet-stream
Date: Thu, 22 Dec 2022 06:31:11 GMT
Server: nginx/1.20.1
Via: kong/2.5.1
X-Kong-Proxy-Latency: 30
X-Kong-Upstream-Latency: 66

this is test service

:::
</dx-codeblock>


### 场景二：实现请求阶段改写 Query 参数
1. 登录 Konga 管理控制台，进入需要配置请求改写的 Service 详情页，单击 **Add Plugin** 添加插件，在 Transformations 分组下选择 TSE PROXY REWRITE 插件。
2. 在插件中填写以下配置，实现响应阶段改写 Query 参数。
![](https://qcloudimg.tencent-cloud.cn/raw/e2cbb9f69ddffe895708840adadc1907.png)
3. 发起 API 请求，查看后端服务是否收到改写的 Query 参数。

### 场景三：实现响应阶段增加 Body
1. 登录 Konga 管理控制台，进入需要配置请求改写的 Service 详情页，单击 **Add Plugin** 添加插件，在 Transformations 分组下选择 TSE PROXY REWRITE 插件。
2. 在插件中填写以下配置，实现响应阶段增加 Body 参数。
![](https://qcloudimg.tencent-cloud.cn/raw/e459926bff2c06fc0e42d0d98651e2a7.png)
>!对 body 参数的操作，需要请求传入 Content-Type 的 Header。仅当 Content-Type 为 application/json, multipart/form-data, application/x-www-form-urlencoded 时，才会进行 body 字段的改写。
3. 发起 API 请求，查看后端服务的响应是否收到新增的 Body 参数。
<dx-codeblock>
:::  yaml
HTTP/1.1 200 OK
Connection: keep-alive
Content-Type: application/json
Date: Thu, 22 Dec 2022 06:53:43 GMT
Server: nginx/1.20.1
Via: kong/2.5.1
X-Kong-Proxy-Latency: 22
X-Kong-Upstream-Latency: 63
Content-Length: 54

{"myreturn":"this is test service","addbody":"return"}

:::
</dx-codeblock>
