## H5 意愿核身介绍
 H5 意愿核身，支持人脸实时检测和光线活体模式，特点如下：
- 支持人脸实时检测，用户交互体验更好。
- 支持动作+光线活体，活体安全性更高。
- 优先实时检测模式，如遇到不兼容的情况，则会平滑切换为视频录制模式。
- 支持多场景接入，包括 App 调用 H5、微信公众号、企业微信、浏览器等。

>! 接入前务必注意：请参见 [移动 H5 意愿核身接入步骤](#H5)  进行接入，如是 App 调用，务必按照 [App 调用 H5 兼容性配置](#AppH5) 进行兼容性适配，否则将影响正常使用。
>
### 兼容性说明
因网页端实时音视频技术是在2017年初次提出，对浏览器和手机系统存在兼容性要求，经过大规模测试，腾讯云 H5 实时检测意愿核身的兼容性情况如下：
<table>
<thead>
<tr>
<th >手机平台</th>
<th >应用端</th>
<th >应用端说明</th>
<th >兼容性要求</th>
<th >机型支持率</th>
</tr>
</thead>
<tbody>
<tr>
<td rowspan=3>iOS</td>
<td>App</td>
<td >在客户自有 App 中使用，适用于在客户 App 中触达用户的业务场景</td>
<td>iOS 系统版本14.3+，需按照 <a href ="#AppH5">App 调用 H5 兼容性配置</a> 做适配</td>
<td>90%</td>
</tr>
<tr>
<td>公众号</td>
<td >在微信公众号中使用，适用于在微信中触达用户的业务场景</td>
<td>iOS 系统版本14.3+，微信版本6.5+</td>
<td>95%</td>
</tr>
<tr>
<td>浏览器</td>
<td >在手机浏览器使用，适用于通过短信或其他方式发送链接触达用户的业务场景</td>
<td>iOS 系统版本11.1.2+，支持 Safari 浏览器，浏览器版本11+</td>
<td>100%</td>
</tr>
<tr>
<td rowspan=4>Android</td>
<td>App</td>
<td >在客户自有 App 中使用，适用于在客户 App 中触达用户的业务场景</td>
<td>Android 系统版本7+，需按照 App 调用 H5 兼容性配置做适配</td>
<td>95%</td>
</tr>
<tr>
<td>公众号</td>
<td >在微信公众号中使用，适用于在微信中触达用户的业务场景</td>
<td>Android 系统版本7+，微信版本6.5+</td>
<td>95%</td>
</tr>
<tr>
<td>自带浏览器</td>
<td >在手机系统自带浏览器使用，适用于通过短信或其他方式发送链接触达用户的业务场景</td>
<td>Android 系统版本7+ 华为、OPPO、VIVO、魅族、荣耀、三星等自带浏览器兼容性较好（支持率80%），小米自带浏览器兼容性一般（支持率30%）</td>
<td>60%</td>
</tr>
<tr>
<td>QQ 浏览器</td>
<td >在 QQ 浏览器使用，适用于通过短信或其他方式发送链接触达用户的业务场景</td>
<td>Android 系统版本7+，支持 QQ 浏览器，不支持 UC、百度浏览器</td>
<td>100%</td>
</tr>
</tbody>
</table>

- 采用达到版本要求的具有一定市场占有率的主流手机型号，测试机型共计829款。
- Android 手机测试品牌名单（按拼音排序）：HTC、OPPO、OPPO_REALME、VIVO、VIVO_IQOO、锤子-坚果、黑鲨、华硕、华为、荣耀、金立、联想、魅族、魅族-魅蓝、努比亚、努比亚-红魔、三星-GALAXY、小米、小米-红米、一加、中兴。

## 移动 H5 意愿核身接入步骤 [](id:H5)

| 序号 | 接入步骤 | 描述 |
|---------|---------|---------|
| 1	| [App 调用 H5 兼容性配置](#AppH5)	 | 如是 App 调用，请务必按照 App调用H5兼容性配置 进行 iOS 及 Android 手机的兼容性适配，否则将影响正常使用。	| 
| 2| 	[合作方后台上送身份信息](#step2)| 	合作方后台上送意愿核身信息，包括 appid、orderNo、name、idNo、userId等。	| 
| 3	| [启动 H5 意愿核身](#step3)	| 合作方上送 faceId 以及 sign，后台校验 sign 通过之后重定向到 H5 意愿核身。	| 
| 4| 	[H5 结果返回及跳转](#step4)	|脸完成后，认证结果页会回调启动 H5 意愿核身入参中指定的回调 URL 地址，使用回调参数中的 code 判断是否核身通过。	| 
| 5| 	[意愿核身结果查询](#step5)| 	当用户完成核身认证后，如果合作方需要拉取意愿核身的视频用于存证等其他需要，可以调用查询核身结果接口来获取。	| 

## App 调用 H5 兼容性配置[](id:AppH5)
请按照下文兼容性配置指引进行 iOS 及 Android 手机的兼容性适配。
### iOS 接入
iPhone 的兼容性适配，需在配置里加上摄像头和麦克风的使用权限。App 的 info.plist 中加入：
```
.NSMicrophoneUsageDescription  
.NSCameraUsageDescription
```
使用 WKWebView 时，需要通过 WKWebViewConfiguration 配置允许使用相机：
```
WKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];
config.allowsInlineMediaPlayback = YES;
```

### Android 接入
由于 Android 机器碎片化严重，用系统 WebView 调起系统摄像头完成视频录制可能存在很多兼容性问题，如部分机器出现调不起摄像头、调起摄像头无法录制视频等。因此整理了接入指引。H5 刷脸包括 trtc 和录制模式，合作方需要对这两种模式都做兼容性配置。
请合作方**务必**按照如下步骤顺序，实现兼容性处理：
1. 引入工具类
将 WBH5FaceVerifySDK.java 文件拷贝到项目中。该文件下载地址：`https://share.weiyun.com/5VTnQgj`（密码请联系对接人获取）。
2. 申请权限
在 Manifest.xml 文件中增加申请以下权限：
```
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
ses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.RECORD_AUDIO" />
```
动态申请权限：
	- 如果第三方编译的 targetSdkVersion >= 23，则需要动态申请权限。
	- 如果第三方编译的 targetSdkVersion < 23，则不需要动态申请权限。
	- 权限代码申请处理逻辑，demo 仅供参考，合作方可根据自身业务需求自行处理。
	- 一定要在动态权限申请成功后，才能去调用 WBH5FaceVerifySDK的enterOldModeFaceVerify() 录制模式或 enterTrtcFaceVerify() trtc 模式体验 h5 刷脸功能。

3. 设置 WebSettings
调用 WebView.loadUrl(String url) 前一行添加如下代码设置 WebSettings。
```
/**
* 对 WebSettings 进行设置：添加 ua 字段和适配 h5 页面布局等
* @param mWebView  第三方的 WebView 对象
* @param context  第三方上下文
*/
WBH5FaceVerifySDK.getInstance().setWebViewSettings(mWebView,getApplicationContext());
```

4. 重写 WebChromeClient
调用 WebView.loadUrl(String url) 前，WebView 必须调用 setWebChromeClient(WebChromeClient webChromeClient)，并重写 WebChromeClient 的如下5个函数：
```
/**
     *TRTC 刷脸模式配置，这里负责处理来自H5页面发出的相机权限申请
     * @param request 来自H5页面的权限请求
     */
    @Override
    public void onPermissionRequest(PermissionRequest request) {
        this.request=request;
        if (activity!=null){ 
            activity.requestCameraPermission();//申请相机权限，申请权限的代码demo仅供参考，合作方可根据自身业务定制
        }
    }

    /**
     * 相机权限申请成功后，拉起TRTC刷脸模式进行实时刷脸验证
     */
    public void enterTrtcFaceVerify(){
        if (Build.VERSION.SDK_INT>Build.VERSION_CODES.LOLLIPOP){ // android sdk 21以上
            if (request!=null&&request.getOrigin()!=null){
                //根据腾讯域名授权，如果合作方对授权域名无限制的话，这个if条件判断可以去掉，直接进行授权即可。
                if (request.getOrigin().toString().contains("https://miniprogram-kyc.tencentcloudapi.com")){
                    //授权
                    request.grant(request.getResources());
                    request.getOrigin();
                }
            }else {
                if (request==null){
                    if (webView!=null&&webView.canGoBack()){
                        webView.goBack();
                    }
                }else {
                }
            }
        }
    }



     // For Android >= 4.1  录制模式中，收到h5页面发送的录制请求
    public void openFileChooser(ValueCallback<Uri> uploadMsg, String acceptType, String capture) {
        this.uploadMsg=uploadMsg;
        this.acceptType=acceptType;
        if (activity!=null){
            activity.requestCameraAndSomePermissions(true);//申请系统的相机、录制和sd卡权限，申请权限的代码demo仅供参考，合作方可根据自身业务定制
        }
    }

    // For Lollipop 5.0+ Devices  录制模式中，收到h5页面发送的录制请求
    @TargetApi(21)
    @Override
    public boolean onShowFileChooser(WebView webView, ValueCallback<Uri[]> filePathCallback, FileChooserParams fileChooserParams) {
        this.webView=webView;
        this.filePathCallback=filePathCallback;
        this.fileChooserParams=fileChooserParams;
        if (activity!=null){
            activity.requestCameraAndSomePermissions(false);//申请系统的相机、录制和sd卡权限，申请权限的代码demo仅供参考，合作方可根据自身业务定制
        }
        return true;
    }

    //录制模式中，拉起系统相机进行录制视频
    public boolean enterOldModeFaceVerify(boolean belowApi21){
        if (belowApi21){ // For Android < 5.0
            if (WBH5FaceVerifySDK.getInstance().recordVideoForApiBelow21(uploadMsg, acceptType, activity)) {
                return true;
            }
        }else { // For Android >= 5.0
            if (WBH5FaceVerifySDK.getInstance().recordVideoForApi21(webView, filePathCallback, activity,fileChooserParams)) {
                return true;
            }
        }
        return false;
    }

```
>! 
>- 如果第三方已重写以上函数，只要将如上述所示的函数体内容添加至第三方的对应函数体首行即可。
>- 如果第三方没有重写以上函数，则直接按上述所示重写。
>- WebView 不要使用 layerType 属性，否则导致刷脸界面白屏。

5. 重写 Activity
>! 
>- 如果第三方 WebView 所属的 Activity 已重写以下函数，则将如下所示的函数体内容添加至第三方的对应函数体首行即可。
>- 如果第三方 WebView 所属的 Activity 没有重写以下函数，则直接按以下代码重写。
>
WebView 所属的 Activity 必须重写如下函数：
```
Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        Log.d(TAG, "onActivityResult --------"+requestCode);
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == VIDEO_REQUEST) {//录制模式中，调用系统相机录制完视频后再回到当前app页面
            if (WBH5FaceVerifySDK.getInstance().receiveH5FaceVerifyResult(requestCode, resultCode, data)) {
                return;
            }
        }else if (requestCode==PERMISSION_QUEST_TRTC_CAMERA_VERIFY){ //trtc模式中，申请相机权限时，从系统设置页面跳转回当前app页面的处理。由于权限申请逻辑demo仅供参考，合作方自己处理即可。
            requestCameraPermission();
        }else if (requestCode==PERMISSION_QUEST_CAMERA_RECORD_VERIFY){//录制模式中，申请权限时，从系统设置页面跳转回当前app页面的处理。由于权限申请逻辑demo仅供参考，合作方自己处理即可。
            requestCameraAndSomePermissions(false);
        }
    }
```
## 合作方初始化上送信息 [](id:step2)
### 生成签名
#### 前置条件
>? 参与签名的数据需要和使用该签名的接口中的请求参数保持一致。
>
请合作方确保 SIGN ticket 已经正常获取，获取方式见 [获取 SIGN ticket](https://cloud.tencent.com/document/product/1007/37305)。合作方根据本次意愿核身的如下参数生成签名，需要签名的参数信息如下：

| 参数名 | 说明 | 来源 |
|---------|---------|---------|
| appId	| 业务流程唯一标识	| 参考 [获取 WBappid](https://cloud.tencent.com/document/product/1007/49634) 指引在意愿核身控制台内申请| 
| userId	| 用户唯一标识| 	合作方自行分配，需跟用户绑定，32位以内，不包含特殊字符| 
| version| 	参数值为：1.0.0	   | -|
| ticket	| 合作伙伴服务端获取的   ticket，注意是 SIGN 类型	|获取方式见  [获取 SIGN ticket](https://cloud.tencent.com/document/product/1007/37305)| 
| nonce	| 必须是 32 位随机数| 	合作方自行生成| 

#### 基本步骤
1. 生成一个 32 位的随机字符串 nonce（其为字母和数字，登录时也要用到）。
2. 将 appId、userId、version 连同 ticket、nonce 共五个参数的值进行字典序排序。
3. 将排序后的所有参数字符串拼接成一个字符串。
4. 将排序后的字符串进行 SHA1 编码，编码后的 40 位字符串作为签名（sign）。
>! 签名算法可参考 [签名算法说明](https://cloud.tencent.com/document/product/1007/37307) 。

#### 参考示例
**请求参数：**

| 参数名 | 参数值 | 
|---------|---------|
| appId	| IDAXXXXX| 
| userId	| userID19959248596551| 
| nonce	| kHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7T| 
| version	| 1.0.0| 
| ticket	| XO99Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMS| 

**字典排序后的参数为：**
```
[1.0.0,IDAXXXXX,XO99Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMS, kHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7T, userID19959248596551]
```

**拼接后的字符串为：**
```
1.0.0IDAXXXXXXO99Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMSkHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7TuserID19959248596551
```

**计算 SHA1 得到签名：**
```
D7606F1741DDCF90757DA924EDCF152A200AC7F0
```
该字串就是最终生成的签名（40 位），不区分大小写。

### 合作方后台上送信息
**请求 URL：**`https://miniprogram-kyc.tencentcloudapi.com/api/server/getWillFaceId?orderNo=xxx`
>! 为方便查询耗时，该请求url后面请拼接 orderNo 订单号参数。
>
**请求方法：POST**
**报文格式：Content-Type: application/json**
**请求参数：**

| 参数 | 说明 | 类型 |长度（字节）	|是否必填|
|---------|---------|---------|---------|---------|	
| appId	| 业务流程唯一标识，即 appid，可参考 [获取 WBappid](https://cloud.tencent.com/document/product/1007/49634) 指引在意愿核身控制台内申请	| String| 	8| 	是| 
| orderNo	| 订单号，由合作方上送，字母/数字组成的字符串,每次唯一，不能超过 32 位	| String| 	不能超过 32 位| 	是| 
| version	| 默认参数值为：1.0.0	| String	| 20| 	是| 
| sign	| 签名：使用上面生成的签名	| String	| 40	| 是| 
| nonce	| 随机数	| String| 	32| 	是| 
| name	| 姓名	| String	| 	-|使用权威源比对时：姓名+证件号，必须输入<br>使用自带源比对时：姓名+证件号，可不输入|
| idNo| 	证件号码	| String	| -	| 使用权威源比对时：姓名+证件号，必须输入<br>使用自带源比对时：姓名+证件号，可不输入| 
| userId	| 用户 ID ，用户的唯一标识（不能带有特殊字符），需要跟生成签名的 userId 保持一致	| String	| 不能超过 32 位	| 是| 
| sourcePhotoStr	| 比对源照片，注意：原始图片不能超过500k，且必须为 JPG 或 PNG、BMP 格式<br>参数有值：使用合作伙伴提供的比对源照片进行比对，必须注意是正脸可信照片，照片质量由合作方保证<br>参数为空 ：根据身份证号 + 姓名使用权威数据源比对	| BASE64String	| 1048576| 	否，非必填<br>请使用标准的图片转 base64方法，base64编码不可包含换行符，不需要加前缀| 
| sourcePhotoType	| 比对源照片类型<br>参数值为1 时是：水纹正脸照<br>参数值为 2 时是：高清正脸照<br>重要提示：照片上无水波纹的为高清照，请勿传错，否则影响比对准确率。如有疑问，请联系腾讯云技术支持线下确认	| String| 	1	| 否，提供比对源照片需要传| 
| liveService	| 应用模式<br>意愿核身默认上送 2	| String| 	32| 	是| 
| liveInterType	| 入参值为“1”表示仅使用实时检测，liveService="2"的场景下，默认入参值仅支持”1“	| String	| 32| 	否| 
| willType	| 意愿核身类型<br>产品服务类型为“2”时，需要填写参数<br>配置：0-问答式<br>默认配置为0	| String| 	32	| 否| 
| willLanguage	| 意愿核身语言<br>产品服务类型为“2”时，需要填写参数配置：0-中文普通话<br>默认配置为0	| String	| 32	| 否| 
| willContentList	| 意愿核身过程中播报文本/问题、用户朗读/回答的文本，当前支持一个播报文本+回答文本	| List	| -|	是| 
| willContentList.id	| 从下标0开始| 	String| 32| 	是| 
| willContentList.question| 	系统播报问题文本/问题<br>长度为60个字以内<br>示例：“ 您好，为确保您本人操作，此次签约全程录音录像。请问您本次业务是本人自愿办理吗？请回答：我确认 ”	| String| 32| 是| 
| willContentList.answer	| 用户朗读/回答的文本，用于识别用户朗读/回答的语音与文本是否一致。长度为10个字以内<br>支持多个文本作为识别内容，文本之间用"&#x399" 分割。<br>示例：我确认	| String| 32| 是| 
                                                  
#### 响应
**响应参数：**

| 参数 | 类型 | 说明 |
|---------|---------|---------|
| code	| String| 	0：成功，非0：失败<br>详情请参见 [SaaS 服务错误码](https://cloud.tencent.com/document/product/1007/47912)| 
| msg	| String	| 请求结果描述| 
| bizSeqNo	| String	| 请求业务流水号| 
| orderNo	| String| 	订单编号| 
| faceId| 	String	| 此次唯一标识，调用时传入| 
| optimalDomain	| String| 	启动 H5 意愿核身步骤中调用 login 接口使用的域名| 

响应示例：
```
{
  "code": 0,
  "msg": "成功",
  "result": {
         "bizSeqNo":"业务流水号"，
         "orderNo":"合作方订单号",
         "faceId":"cc1184c3995c71a731357f9812aab988"
         "optimalDomain":"miniprogram-kyc.tencentcloudapi.com"       
  }
}
```
## 启动 H5 意愿核身[](id:step3)
### 前置条件
合作方如果使用 App 内调起 H5 意愿核身，需要 App 平台的 webkit/blink 等组件支持调用摄像头录视频，方可正常使用意愿核身功能。
>? 
>- App 内调用 H5 意愿核身或者短信链接调用 H5 意愿核身等场景，若当前设备无法正常调用摄像头进行视频录制，前端将返回特定的错误码（如下）告知合作方，合作方拿到错误码后可选择用备用方案核身处理。
>- 在 App、微信公众号、浏览器中调用H5实时检测意愿核身，需要用户允许使用摄像头权限（授权操作形式包括弹窗、动作菜单、应用设置等，具体形式视手机型号而异）。如用户误操作导致拒绝授权，需要退出意愿核身并重新进入和允许授权。部分浏览器会缓存用户之前的授权操作，故如果退出意愿核身并重新进入时仍然出现无摄像头权限的情况，可以尝试清除浏览器缓存。
>

| 返回码 | 返回信息 | 处理措施 |
|---------|---------|---------|
| 3001	| 该浏览器不支持视频录制	| 请使用其它验证方案| 
| 3002	| 登录态异常，cookie 参数缺失	| 重新进入| 
| 3003	| 意愿核身中途中断	| 重新进入| 
| 3004	| 无摄像头权限	| 重新进入并授权摄像头| 
| 3005	| 该浏览器不支持实时检测模式	| 请使用其它浏览器| 
| 3006	| 该功能仅支持微信环境打开	| 请使用微信进入| 
| 300101	| 报文包体问题	| 重新进入| 

摄像头授权操作示例：
![](https://qcloudimg.tencent-cloud.cn/raw/5e34fa8182b6f4245c18c8e73e0b92d2.png)

### 生成签名
#### 前置条件
请合作方确保 NONCE ticket 已经正常获取，获取方式见 [获取 NONCE ticket](https://cloud.tencent.com/document/product/1007/37306) 。合作方根据本次意愿核身的如下参数生成签名,需要签名的参数信息如下：
>? 参与签名的数据需要和使用该签名的接口中的请求参数保持一致。

| 参数 | 说明 | 来源 |
|---------|---------|---------|
| appId| 	业务流程唯一标识	| 参考 [获取 WBappid](https://cloud.tencent.com/document/product/1007/49634)  指引在意愿核身控制台内申请| 
| orderNo	| 订单号，本次意愿核身合作伙伴上送的订单号，字母/数字组成的字符串，唯一标识| 	合作方自行分配| 
| userId	| 用户 ID ，用户的唯一标识（不要带有特殊字符）	| 合作方自行分配（与接口中使用的 userId 保持一致）| 
| version	| 参数值为：1.0.0| 	-| 
| faceId	| getfaceid 接口返回的唯一标识	| -| 
| ticket	| 合作伙伴服务端获取的 tikcet，注意是 NONCE 类型	|获取方式见 [获取 NONCE ticket](https://cloud.tencent.com/document/product/1007/37306)（所用的 userid 参数值需要和接口里面的 userId 值保持一致）| 
| nonce	| 随机数：32位随机串（字母 + 数字组成的随机数）	| 合作方自行生成（与接口中的随机数保持一致）| 

#### 基本步骤
1. 生成一个32位的随机字符串（字母和数字）nonce（接口请求时也要用到）。
2. 将 appId、userId、orderNo、version、faceId 连同 ticket、nonce 共7个参数的值进行字典序排序。
3. 将排序后的所有参数字符串拼接成一个字符串。
4. 将排序后的字符串进行 SHA1 编码，编码后的40位字符串作为签名（sign）。签名算法可参考 [签名算法说明](https://cloud.tencent.com/document/product/1007/37307)。
#### 参考示例
请求参数：

| 参数名 | 参数值 | 
|---------|---------|
| appId	| appId001| 
| userId	| userID19959248596551| 
| nonce	| kHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7T| 
| version	| 1.0.0| 
| faceId	| bwiwe1457895464| 
| orderNo	| aabc1457895464| 
|ticket	| zxc9Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMS| 

字典排序后的参数为：
```
[1.0.0, aabc1457895464, appId001, bwiwe1457895464, kHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7T, userID19959248596551, zxc9Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMS]
```


拼接后的字符串为：
```
1.0.0aabc1457895464appId001bwiwe1457895464kHoSxvLZGxSoFsjxlbzEoUzh5PAnTU7TuserID19959248596551zxc9Qfxlti9iTVgHAjwvJdAZKN3nMuUhrsPdPlPVKlcyS50N6tlLnfuFBPIucaMS
```

计算 SHA1 得到签名：
```
4E9DFABF938BF37BDB7A7DC25CCA1233D12D986B
```
该字串就是最终生成的签名（40位），不区分大小写。

### 启动 H5 意愿核身
合作方上送 faceId 以及 sign，后台校验 sign 通过之后重定向到 H5 意愿核身。
>! 为了保证服务的高可用，全面消除单点风险，我们启用了多域名服务。启动 H5 意愿核身需要使用 [合作方初始化上送信息](#step2) 接口返回内容中 optimalDomain 字段的域名。
>
**请求 URL：**`https://miniprogram-kyc.tencentcloudapi.com/api/web/willLogin`

optimalDomain 使用 合作方后台上送接口返回的 optimalDomain 域名，如果 optimalDomain 字段返回为空或者取不到，默认使用域名 miniprogram-kyc.tencentcloudapi.com。
该跳转 url 不能直接暴露在前端 html 页面的&lta&gt标签中。某些浏览器会预加载&lta&gt标签中的 url，导致用户点击访问该 url 时，因 url 已经被预加载访问过，于是签名失效，页面报错“签名不合法”。
请求方法：GET
**请求参数：**

| 参数 | 说明 | 类型 |长度| 
|---------|---------|---------|---------|
| appId	| 参考 [获取 WBappid ](https://cloud.tencent.com/document/product/1007/49634)指引在意愿核身控制台内申请	| String| 	8| 
| version	| 接口版本号，默认参数值1.0.0| 	String| 20| 
| nonce| 	随机数：32位随机串（字母 + 数字组成的随机数）	| String	| 32| 
| orderNo	| 订单号，由合作方上送，字母/数字组成的字符串,每次唯一，此信息为本次意愿核身上送的信息，不能超过32位	| String| 	32| 
| faceId	| getWillFaceId 接口返回的唯一标识	| String| 	32| 
| url	| H5 意愿核身完成后回调的第三方 URL，需要第三方提供完整 URL 且做 URL Encode。完整 URL Encode 示例：<br>原 URL：`https://cloud.tencent.com` <br>Encode 后：`https%3a%2f%2fcloud.tencent.com`	| String| 	-| 
| resultType	| 是否显示结果页面，参数值为“1”时直接跳转到 url 回调地址，null 或其他值跳转提供的结果页面	| String	| -| 
| userId	| 用户 ID ，用户的唯一标识（不要带有特殊字符）	| String	| -| 
| sign	| 签名：使用上面生成的签名	| String	| 40| 
| from	| browser：表示在浏览器启动刷脸<br>App：表示在 App 里启动刷脸，默认值为 App	| String| 	-| 
| redirectType	| 跳转模式，参数值为“1”时，刷脸页面使用 replace 方式跳转，不在浏览器 history 中留下记录；不传或其他值则正常跳转	| String| 	-| 

**请求示例：**
```
https://miniprogram-kyc.tencentcloudapi.com/api/web/willLogin?appId=appId001
&version=1.0.0
&nonce=4bu6a5nv9t678m2t9je5819q46y9hf93
&orderNo=161709188560917432576916585
&faceId=wb04f10695c3651ce155fea7070b74c9
&url=https%3a%2f%2fcloud.tencent.com
&from=browser
&userId=23333333333333
&sign=5DD4184F4FB26B7B9F6DC3D7D2AB3319E5F7415F
&redirectType=1

```

## H5 结果返回及跳转[](id:step4)
认证结束后，认证结果页会回调启动 H5 意愿核身入参中指定的回调 URL 地址。并带有 code、orderNo、faceId 等参数。
您可以根据我们刷脸完成后的回调请求参数中的 code 判断是否核身通过，code 0 表示意愿核身成功，其他错误码表示失败。如果您需要二次验证结果准确性，您可以通过服务端查询接口获取最终认证结果。服务端获取验证结果能够返回意愿核身的结果以及相应的视频和图片用于您存证等其他需要。（请注意：务必在收到完成刷脸的回调后，再来调用服务端获取验证结果获取。）
**参数说明：**

| 参数 | 说明 | 
|---------|---------|
| code	| 意愿核身结果的返回码，0 表示成功，其他错误码标识失败| 
| faceCode	| 意愿核身结果返回码| 
| willCode	| 意愿表达结果返回码| 
| orderNo	| 订单号 ，本次意愿核身上送的订单号| 
| faceId	| 本次请求返回的唯一标识，此信息为本次意愿核身上送的信息| 
| newSignature	| 对 URL 参数 App ID、orderNo 和 SIGN ticket、code 的签名| 
| liveRate	| 本次意愿核身的活体检测分数| 

>! 
>- 若 H5 浏览器不支持调用摄像头录制视频，则直接返回错误 code（详见 [启动 H5 意愿核身](#step3) 的前置条件）。
>- 在 H5 实时检测模式中，若意愿核身过程中发生中断，例如 App 被切换到后台等情况，前端会返回特定的错误码3003（意愿核身中途中断）。

## 意愿核身查询结果[](id:step5)
### 合作伙伴服务端验证结果
此方式用于合作伙伴服务端生成签名，并调用意愿核身服务端查询结果，鉴权完成后返回结果（服务端上送 orderNo 和 appId 查询）。
#### 合作方后台生成签名
准备步骤：
1. 前置条件：
请合作方确保 SIGN ticket 已经正常获取，获取方式见 [获取 SIGN ticket](https://cloud.tencent.com/document/product/1007/37305)。
2. 合作方为意愿核身查询服务生成签名，需要具有以下参数：

| 参数 | 说明 | 来源 |
|---------|---------|---------|
|appId	|腾讯服务分配的 Appid |参考 [获取 WBappid](https://cloud.tencent.com/document/product/1007/49634) 指引在意愿核身控制台内申请 |
| orderNo	| 订单号，本次意愿核身合作伙伴上送的订单号，唯一标识，字母/数字组成的字符串	| 合作方自行分配| 
| version	| 默认值：1.0.0	 |-|
| ticket	| 合作伙伴服务端缓存的 tikcet，注意是 SIGN 类型	| 获取方式见 [获取 SIGN ticket](https://cloud.tencent.com/document/product/1007/37305)| 
| nonceStr	| 32 位随机字符串，字母和数字	| 合作方自行生成| 

基本步骤：
1. 生成一个 32 位的随机字符串 nonceStr（其为字母和数字，登录时也要用到）。
2. 将 appId、orderNo、version 连同 ticket、nonceStr 共五个参数的值进行字典序排序。
3. 将排序后的所有参数字符串拼接成一个字符串。
4. 将排序后的字符串进行 SHA1 编码，编码后的 40 位字符串作为签名（sign）。

>! 签名算法可参考 [签名算法说明](https://cloud.tencent.com/document/product/1007/37307) 。

### 识别结果查询接口
**请求 URL**：`https://miniprogram-kyc.tencentcloudapi.com/api/server/getWillFaceResult?orderNo=xxxx`
**请求方法：POST**
**报文格式：**Content-Type: application/json
**请求参数：**

| 参数 | 说明 | 类型 |长度（字节）	|是否必填|
|---------|---------|---------|---------|---------|	
| appId	| 腾讯服务分配的 Appid	| 字符串	| 腾讯服务分配	| 是| 
| orderNo	| 订单号，合作方订单的唯一标识，字母/数字组成的字符串| 	字符串| 	32| 	是| 
| nonce	| 随机数	| 字符串| 	32	| 是| 
| version	| 版本号，默认值：1.0.0	| 字符串	| 20	| 是| 
| sign	| 签名值，使用本页第一步生成的签名| 	字符串	| 40| 	是| 
| getFile	| 是否需要获取人脸识别的视频和文件，值为1则返回视频和照片、值为2则返回照片、值为3则返回视频；其他则不返回	| 字符串| 	40| 	是| 
| getWillFile	| 是否需要获取意愿表达的音频文件，默认值为1，值为1-返回，其他值为不返回	| 字符串	| 40	| 是| 

**响应参数：**	

| 参数 | 类型 | 说明 |
|---------|---------|---------|
| code	| String	| 0代表成功| 
| msg	| String| 	返回结果描述| 
| faceCode	| String	| 意愿核身结果| 
| faceMsg| 	String| 	意愿核身结果描述| 
| willCode	| String| 	意愿表达结果| 
| willMsg	| String| 	意愿表达结果描述| 
| bizSeqNo	| String	| 业务流水号| 
| transactionTime	| String	| 请求接口的时间| 
| orderNo	| String	| 订单编号| 
| liveRate| 	String	| 活体检测得分| 
| riskInfo	| object	| 后台返回的刷脸风险信息| 
| similarity	| String	| 人脸比对得分| 
| occurredTime	| String	| 进行刷脸的时间| 
| photo	| String	| 意愿核身时的照片，base64 位编码| 
| video	|  String	| 意愿核身时的视频，base64 位编码| 
| sdkVersion	| String	| 意愿核身时的 sdk 版本号| 
|appId	|String	|腾讯云控制台申请的 appid|
|willUserAudio	|  String	|意愿核身用户音频 意愿表达阶段的音频文件，base64位编码|
|willReadAudio|	 String	|意愿核身播报音频 意愿表达阶段的音频文件，base64位编码|
|willUserVideo	| String	|意愿核身完整视频：从用户播报音频到回复音频过程，base64位编码|
|willStandText	|String	|客户初始化上送的文字信息|
|willStandAnswer|	String	|客户初始化上送的答案文字信息|
|willUserAnswer	|String|	识别结果文本信息|

```
{
   {
    "code": "66660005",
    "msg": "无法确认为同一人",
    "AppId": "IDAjkNoN",
    "orderNo": "testReflect1652967826705",
       "similarity": "7.0",
    "liveRate": "99",
    "occurredTime": "20220519214415",
    "riskInfo": {
        "deviceInfoLevel": "1",
        "deviceInfoTag": ""
    },
    "faceCode": "66660005",
    "faceMsg": "无法确认为同一人",
    "willCode": "15830007",
    "willMsg": "意愿识别结果与答案不一致",
    "willUserAudio": "+wH9AaIBQHwDVAsgCIMFsQi6BRf7Yfuk/lf6RvqA/2v+tvqF9TfyF+kl+UsCYv3MD5MYRhKOEMYNFQIY+n/16PVC+VJJRkYAAAAAV0FWRWZtdCAQAAAAAQABAEAfAADQBwAAAgAQAGRhdGEAAAAA",
    "willReadAudio": "UklGRuQnBABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YcAnBAAAAAAAAAAAAAAAAAAAAAAAAA",
    "willStandText": "本人知情以下号码开户，知晓出售、出租、转让等方式提供电话卡供他人使用的法律风险。",
    "willStandAnswer": "是的",
    "willUserAnswer": "不是"
}
```

#### 注意事项
- code 非 0 时，有时不返回图片和视频。
- 照片和视频信息作为存证，合作伙伴可以通过此接口拉取视频等文件，需要注意请求参数的 get_file 需要设置为 1；如果不上送参数或者参数为空，默认不返回视频和照片信息。为确保用户操作整体流程顺利完成，部分情况下获取视频和照片会有1秒左右的延迟。
- 由于照片和视频信息有可能超过 1M，考虑传输的影响，建议合作伙伴在使用时注意，建议获取比对结果用于后续流程处理和存证使用分开调用。避免网络传输带来的影响。目前我们的查询接口是异步查询，返回的文件可能会有1~2s的延迟。
- 如果合作方是完成意愿核身流程后马上去拉取视频/照片，建议在查询接口加上一个查询机制：判断图片是否存在，轮询3次，每次2s。
- 照片和视频均为 base64 位编码，其中照片解码后格式一般为 JPG 和 PNG。视频格式解码后一般为 MP4。
- 服务端验证结果接口返回66660011无此查询结果的可能原因：66660017 验证次数超限后被风控，风控后的订单为无效，查询结果为无此查询结果。
	- 用户中途退出刷脸，没有完成人脸验证的流程，没有比对，查询结果为无此查询结果。
	- 66660018 操作超时，请退出重试 无此 ID 的用户身份信息，faceid 5分钟有效期，失效后无法进入刷脸流程，查询结果为无此查询结果。
	- 66660016 视频格式或大小不合法 文件或视频不合法，无法进行比对，查询结果为无此查询结果。
	- 400604 上传的视频非实时录制,被时间戳校验拦截，查询结果为无此查询结果。
	- 查询超过3天的订单返回无此查询结果。
- 响应参数请勿做强校验，后续可能会有扩展。 

### 服务响应码
详情请参见 [SaaS 服务错误码](https://cloud.tencent.com/document/product/1007/47912)。


